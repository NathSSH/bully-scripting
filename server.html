<!DOCTYPE html>
<html>
	<head>
		<title>DSL Server Manual</title>
		<style>
			:root{
				color-scheme: dark;
				font-family: Helvetica, Arial;
			}
			body{
				margin-left: auto;
				margin-right: auto;
				max-width: 80rem;
			}
			#content{
				background-color: #0C0C0C;
				border-radius: 1rem;
				padding-bottom: 1rem;
				padding-left: 1rem;
				padding-right: 1rem;
			}
			#index a{
				display: block;
				margin-bottom: 1rem;
				text-decoration: none;
			}
			#index a:hover{
				text-decoration: underline;
			}
			code{
				background-color: #202020;
				border-radius: 0.5rem;
				display: block;
				font-family: "Lucida Console", Consolas;
				font-style: normal;
				overflow-x: clip;
				padding: 0.5rem;
				tab-size: 4;
				white-space: pre-wrap;
			}
			dfn{
				background-color: #000000;
				font-family: "Lucida Console", Consolas;
				font-style: normal;
			}
			li{
				margin-bottom: 0.5rem;
			}
			hr{
				margin-top: 2rem;
			}
			h1{
				font-family: Arial;
				font-weight: 900;
				text-align: center;
			}
			h2{
				font-family: Arial;
				font-weight: 900;
			}
			h3{
				font-family: Arial;
				font-weight: bold;
			}
		</style>
	</head>
	<body>
		<div id="content">
			<h1>derpy's script server - server manual</h1>
			<hr/>
			<div id="index">
				<h2>Setup</h2>
				<a href="#start">Getting started</a>
				<a href="#config">Configuring your server</a>
				<a href="#setup">Setting up your scripts</a>
				<a href="#host">Hosting your server</a>
				<h2>Scripts</h2>
				<a href="#account">extras/account</a>
				<a href="#admin">extras/admin</a>
				<a href="#chat">extras/chat</a>
				<a href="#loadanim">extras/loadanim</a>
				<a href="#menu">extras/menu</a>
				<a href="#profanity">extras/profanity</a>
			</div>
			<hr/>
			<h2 id="start">Getting started</h2>
			<p>
				Before setting up your server, you should already be familiar with the basics of <a href="http://bullyscripting.net/dsl/about.html">derpy's script loader (DSL)</a>
				and how <a href="http://bullyscripting.net/dsl/collections.html">DSL collections<a> work.
				Once you are confident with using the loader itself, you should be ready to setup a server (which you can download <a href="http://bullyscripting.net/downloads.html#dsl">here</a>).
			</p>
			<p>
				Once you have the server version, you must decide if you want to run the server using Windows or Linux.
				It is recommended you use Windows (<b>derpy_script_server.exe</b>) when starting out and only move to Linux (<b>./derpy_script_server</b>) later if you decide it is more cost-effective for you.
			</p>
			<p>
				The directory (or folder) you run the executable in is where all your files will go.
				You should at least have the <b>scripts</b> folder by the executable before you run it.
				After you start the server for the first time, a <b>config.txt</b> file will be generated and you may configure it before starting again.
			</p>
			<h2 id="config">Configuring your server</h2>
			<p>
				For the most part, <b>config.txt</b> documents itself and you should be able to figure out what to change.
				The only things that you should really need to change are <b>server_name</b>, <b>server_info</b>,
				and if you'd like you can uncomment <b>server_icon</b> and set it to a 1:1 PNG in the same directory that is no more than 100 KiB.
			</p>
			<p>
				If you are only making this server for a few friends and you want to make sure nobody joins that isn't supposed to, you can setup a whitelist by
				setting <b>whitelist_instead</b> to <b>true</b> and uncommenting <b>whitelist_ip</b> and setting it to someone's IP.
				You can then add as many more IPs as you want by duplicating that line.
			</p>
			<h2 id="setup">Setting up your scripts</h2>
			<p>
				By itself, a server will do nothing to players' games. It is only through scripts that anything happens, including any sort of game sync.
				There are a few script collections that come with the server (in the <b>extras</b> folder) and the rest will need to be downloaded elsewhere.
				Copy (or move) as many scripts as you want to your server scripts, and control them using the same commands you'd use on the client.
				Commands can be typed directly into Windows servers, but must be done remotely on Linux servers (for now).
			</p>
			<p>
				All scripts in <b>extras</b> have their own <b>config.txt</b> that you should check out and configure if you decide to use them.
				Some scripts can integrate with each other, but none are configured to do so by default.
				All of these scripts are documented in this manual for both server owners and scripters looking to integrate with them.
			</p>
			<p>
				If you are interested in making your own network scripts, you can check out <a href="http://bullyscripting.net/dsl/network.html">this page</a> to get started.
			</p>
			<p>
				The most recent version of the official scripts are available on <a href="https://github.com/derpy54320/dss-extras">github</a>.
			</p>
			<h2 id="host">Hosting your server</h2>
			<p>
				It is recommended you host your server locally using Windows when setting one up for the first time, and move it to a dedicated server when it is ready to be played by the public.
				There are many services that will let you rent a <a href="https://en.wikipedia.org/wiki/Virtual_private_server">VPS</a> if you do not have a server yet,
				<a href="https://www.vultr.com/">Vultr</a> being a fairly good choice.
				It is often more cost-effective to rent a Linux server than a Windows one as mentioned earlier, but either will work of course.
			</p>
			<p>
				Once your server is up, you should be able to connect to it by turning on <b>allow_networking</b> in your DSL <b>config.txt</b> and then using <i>/connect</i> in-game.
				If everything seems okay, you can share your server's IP with your friends to start playing!
				It is suggested you restart the server at least every few days to keep it running well.
			</p>
			<p>
				If you have problems, make sure the port for your server is open (<b>17017</b> by default) and that your firewall allows in-bound connections for the server.
			</p>
			<hr/>
			<h2 id="account">extras/account</h2>
			<h3>Summary</h3>
			<p>
				These scripts make players create an account to play on the server.
				This ensures that every player has some unique identifier (their username) that other scripts can use when saving data that should be tied to a certain player.
				Accounts can also have <i>roles</i> attached to them, which other scripts can check for.
			</p>
			<h3>Integrations</h3>
			<ul>
				<li><b>profanity</b>: restrict players from creating accounts with profane usernames.</li>
			</ul>
			<h3>Commands (server)</h3>
			<ul>
				<li><b>/check_account &lt;user&gt;</b>: check if an account exists, is being used, and what roles it has.</li>
				<li><b>/check_accounts [count]</b>: print statistics related to accounts, and optionally list accounts in alphabetical order.</li>
				<li><b>/delete_account &lt;user&gt;</b>: delete a specific account.</li>
				<li><b>/demote_account &lt;user&gt; [role]</b>: strip an account of a specific role or of all roles.</li>
				<li><b>/promote_account &lt;user&gt; &lt;role&gt;</b>: give an account some role that other scripts can check for.</li>
				<li><b>/reset_accounts</b>: reset all account data, totally destroying every account.</li>
				<li><b>/unlimit_accounts &lt;player_id&gt;</b>: temporarily allow a player to make as many accounts as they want.</li>
				<li><b>/verify_accounts</b>: tell all running scripts to verify their account data and cleanup anything related to deleted accounts.</li>
			</ul>
			<h3>Local Events (server)</h3>
			<ul>
				<li><b>account:deleteAccount(user)</b>: an account has been deleted and all references to this username should be removed.<br/>
				Return <b>true</b> to tell the server something failed, which will tell the server owner to try <i>/verify_accounts</i>.</li>
				<li><b>account:playerSignedIn(player, user)</b>: a player has signed in and was not signed in before.<br/>
				This event is only run when the player is valid and connected.</li>
				<li><b>account:playerSignedOut(player)</b>: a player has signed out (and may not be valid anymore).<br/>
				All players are signed out when the account scripts stop or when accounts are reset using <i>/reset_accounts</i>.</li>
				<li><b>account:playerUpdatedRoles(player)</b>: a player had their roles changed (happens after a sign-in, sign-out, promotion, or demotion).<br/>
				This event is only run when the player is valid and connected.</li>
				<li><b>account:scriptStopping</b>: the account system's script collection is stopping.<br/>
				Runs before players are signed out, so you can remove player account references early if desired.</li>
				<li><b>account:verifyAccounts(check)</b>: the server wants all scripts to verify that all their references to usernames are valid (using <dfn>if check(user) then ...</dfn>).<br/>
				Return <b>true</b> to tell the server something failed, which will tell the server owner to try <i>/verify_accounts</i>.</li>
			</ul>
			<h3>Shared Functions (server)</h3>
			<ul>
				<li><b>dsl.account.all_players()</b>: returns an iterator for all signed in players (so you can use <dfn>for player, user do ...</dfn>).</li>
				<li><b>dsl.account.get_player_username(player)</b>: returns the username of a player if they're signed in (and <b>nil</b> otherwise, so you can check <i>if</i> they're even signed in).</li>
				<li><b>dsl.account.is_player_role(player, role)</b>: returns <b>true</b> if the player is signed in and has the role (and <b>false</b> otherwise).</li>
			</ul>
			<h3>Shared Functions (client)</h3>
			<ul>
				<li><b>dsl.account.get_username()</b>: returns the username of the player if they're signed in (and <b>nil</b> otherwise, so you can check <i>if</i> they're even signed in).</li>
				<li><b>dsl.account.is_ui_active()</b>: returns <b>true</b> if the account UI is active (and <b>false</b> otherwise, so you can disable your UI while it is up).</li>
			</ul>
			<hr/>
			<h2 id="admin">extras/admin</h2>
			<h3>Summary</h3>
			<p>
				These scripts provide administrative and moderative commands. Players can be authenticated using an IP or an account role if applicable.
				Commands are only registered for players that are allowed to use them (but even then the server will verify them before doing anything).
			</p>
			<h3>Integrations</h3>
			<ul>
				<li><b>account</b>: use roles to determine admins / mods, and show usernames in the <i>/players</i> command.</li>
			</ul>
			<h3>Commands (client)</h3>
			<ul>
				<li><b>/ban &lt;id&gt; [reason]</b>: temporarily ban a player (until the scripts are stopped).</li>
				<li><b>/kick &lt;id&gt; [reason]</b>: kick a player.</li>
				<li><b>/players</b>: list all player IDs.</li>
				<li><b>/server [...]</b>: remotely run a command on the server.</li>
			</ul>
			<h3>Local Events (server)</h3>
			<ul>
				<li><b>admin:playerUpdated(player)</b>: a player's rank has been updated, so you should update any cached information about their rank.<br/>
				This event is only run when the player is valid and connected.</li>
			</ul>
			<h3>Shared Functions (server)</h3>
			<ul>
				<li><b>dsl.admin.is_player_admin(player)</b>: returns <b>true</b> if the player is an admin, and <b>false</b> otherwise.</li>
				<li><b>dsl.admin.is_player_mod(player)</b>: returns <b>true</b> if the player is an admin <i>or</i> moderator, and <b>false</b> otherwise.</li>
				<li><b>dsl.admin.update_player(player)</b>: update the player's rank and trigger an <i>admin:playerUpdated</i> event. Usually not needed unless you have a reason.</li>
			</ul>
			<hr/>
			<h2 id="chat">extras/chat</h2>
			<h3>Summary</h3>
			<p>
				These scripts are for the chat. Press <b>enter</b> or <b>/</b> to start sending a message or run a command.
			</p>
			<h3>Integrations</h3>
			<ul>
				<li><b>account</b>: show usernames instead of player names and ensure proper UI timing.</li>
				<li><b>admin</b>: show player ID numbers to moderators.</li>
				<li><b>profanity</b>: censor profane player messages.</li>
			</ul>
			<h3>Commands (server)</h3>
			<ul>
				<li><b>/say &lt;message&gt;</b>: send a server message to all players.</li>
			</ul>
			<h3>Local Events (server)</h3>
			<ul>
				<li><b>chat:playerMessage(player,msg)</b>: a player is sending a message. The <i>msg</i> table contains data about the message, some of which can be modified.<br/>
				Return <b>true</b> to not send the message. The <i>msg</i> table contains these fields: <i>name</i>, <i>message</i>, <i>moderator</i>, and <i>color</i>.</li>
			</ul>
			<h3>Shared Functions (server)</h3>
			<ul>
				<li><b>dsl.chat.notify(target, message, red, green, blue)</b>: same as the client version, but takes a target player. Use <b>-1</b> for all players.</li>
				<li><b>dsl.chat.say(target, name, message, red, green, blue)</b>: same as the client version, but takes a target player. Use <b>-1</b> for all players.</li>
			</ul>
			<h3>Shared Functions (client)</h3>
			<ul>
				<li><b>dsl.chat.notify(message, red, green, blue)</b>: print a notification in the chat, and optionally specify a custom text color.</li>
				<li><b>dsl.chat.say(name, message, red, green, blue)</b>: print a message in the chat, and optionally specify a custom name color.</li>
			</ul>
			<hr/>
			<h2 id="loadanim">extras/loadanim</h2>
			<h3>Summary</h3>
			<p>
				The same loadanim.lua script that normally comes with DSL. Loads all animation groups so other scripts don't have to worry about it.
			</p>
			<hr/>
			<h2 id="menu">extras/menu</h2>
			<h3>Summary</h3>
			<p>
				These scripts are for the server menu. It is totally client side and serves as a central menu system for other scripts to integrate with.
			</p>
			<h3>Local Events (client)</h3>
			<ul>
				<li><b>menu:openMain(add)</b>: the main menu is opening and you should add options (using <dfn>add("My Option", F_MyOption)</dfn>).<br/>
				Return <b>true</b> to stop the menu. The <i>add</i> function creates a thread in the handling script that runs when selected.</li>
			</ul>
			<h3>Shared Functions (client)</h3>
			<p>
				You should usually only create a menu during a callback registered during the <i>menu:openMain</i> event.
				Callbacks run on the same thread as the main menu, so they will properly keep it from being used until your callback returns.
				If you do make your own menu at a different time, return <b>true</b> during <i>menu:openMain</i> while it is running.
			</p>
			<ul>
				<li><b>dsl.menu.create(title, help)</b>: creates a new <i>menu</i> object.</li>
				<li><b>dsl.menu.submenu(title, help)</b>: creates a new <i>menu</i> object that inherits the style of the main menu.</li>
				<li><b>dsl.menu.extend(help)</b>: creates a new <i>menu</i> object that inherits the style of the main menu and draws to the right of it.</li>
				<li><b>dsl.menu.is_active()</b>: returns true if the menu is active.</li>
			</ul>
			<h3>Menu Object (client)</h3>
			<p>
				The menu system works by adding a bunch of options with <i>menu:option</i> and drawing with <i>menu:draw</i> each frame.
				After the menu is drawn, it lets the user control it the next time it is updated (the next frame).
				When a selection is made, the menu will remember which option it was (based on position and text) and return <b>true</b> next time the option is added.
				This lets you handle your option however you like and also keeps the options past that point from being updated until the menu is drawn again,
				which helps you not have to worry about control flow as much (which means you can <b>elseif</b> options together for convenience).
			</p>
			<p>
				These are methods for <i>menu</i> objects returned by <b>dsl.menu.create</b> and <b>dsl.menu.extend</b>.
			</p>
			<ul>
				<li><b>menu:active()</b>: returns true while the menu is active, and updates the menu if needed.<br/>
				Usually you will be simply using this method in a <b>while</b> to loop make your menu loop.</li>
				<li><b>menu:option(text, right_text, description_text)</b>: adds an option to the menu, and updates the menu if needed.<br/>
				Returns <b>true</b> if it was just selected. All arguments are optional and can be skipped using <b>nil</b>.</li>
				<li><b>menu:alert(text, seconds)</b>: show some text in the description box. Takes priority over menu and option help text.<br/>
				If <i>seconds</i> is not given (or isn't positive), it will only be used for one draw.</li>
				<li><b>menu:help(text)</b>: set the help text associated with the menu. Has the lowest priority for the description box.<br/>
				This sets the same thing as the <i>help</i> argument for menu creation. It can also be <b>nil</b>.</li>
				<li><b>menu:draw(keep)</b>: draws the menu, and updates it first if needed. Resets all options and allows input to be processed next menu update. Returns <i>x, y, w, h</i>.<br/>
				If <i>keep</i> is given, options will not reset. If <i>keep</i> is given but not a boolean, it updates the <i>right_text</i> for the current option to allow a "selector".</li>
				<li><b>menu:up()</b>: uses the menu navigation controls and logic to determine if the user hit up. Also plays a sound.<br/>
				There are also methods for <b>down</b>, <b>left</b>, and <b>right</b> that do not explicitly listed here.
				<li><b>menu:submenu(help)</b>: creates and returns a new menu that inherits this menu's <i>draw_style</i>.<br/>
				The style is copied by value, so you can change it independently of the original.</li>
				<li><b>menu:extend(help)</b>: creates and returns a new menu that inherits this menu's <i>draw_style</i> and draws to the right of it.<br/>
				Usually it is neater to just make a new menu than to keep extending right.</li>
				<li><b>menu:style(name)</b>: apply a pre-defined style to the menu instead of changing <i>draw_style</i> manually.<br/>
				As of writing this, options include <i>"default"</i> and <i>"alternate"</i>.</li>
			</ul>
			<p>
				These are fields in <i>menu</i> objects that can be changed (other fields should not be changed).
			</p>
			<ul>
				<li><b>menu.can_exit</b>: determines if the menu can be exited by pressing left.<br/>
				By default this is <b>true</b>.</li>
				<li><b>menu.fix_camera</b>: determines if the game's camera will be scripted to not change when hitting up.<br/>
				By default this is <b>true</b>.</li>
				<li><b>menu.title_format</b>: a text formatting table for the format of title text.<br/>
				There are also fields for <b>option_format</b> and <b>description_format</b>.</li>
				<li><b>menu.draw_style</b>: a table that describes how the menu should be drawn.<br/>
				Changing this will require you to look in the source to see how.</li>
			</ul>
			<code>-- menu example: make a new menu that can be accessed from the main menu

RegisterLocalEventHandler("menu:openMain",function(add)
	add("My Menu", M_MyMenu)
end)

function M_MyMenu()
	local menu = dsl.menu.create("My Menu")
	while menu:active() do
		if menu:option("Give Spud Gun") then
			PedSetWeapon(gPlayer, 305, 8, false)
		elseif menu:option("Give Bottle Rocket Launcher") then
			PedSetWeapon(gPlayer, 307, 8, false)
		end
		menu:draw()
		Wait(0)
	end
end</code>
			<hr/>
			<h2 id="profanity">extras/profanity</h2>
			<h3>Summary</h3>
			<p>
				These scripts check for profanity. They do not do anything by themselves, and only provide other scripts with a way to check for profanity.
			</p>
			<h3>Shared Functions (server &amp; client)</h3>
			<ul>
				<li><b>dsl.profanity.is_dirty_str(str, level)</b>: returns <b>true</b> if the string contains profanity, optionally using a custom profanity level.</li>
				<li><b>dsl.profanity.get_clean_str(str, level)</b>: returns a censored version of the string (can be slow, so it is suggested you don't use it on the server).</li>
			</ul>
		</div>
	</body>
</html>
